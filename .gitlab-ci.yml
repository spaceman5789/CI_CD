stages:
  - lint_test
  - build
  - scan
  - push
  - deploy

variables:
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  IMAGE_LATEST: $CI_REGISTRY_IMAGE:latest
  STAGING_PATH: /opt/app

lint_test:
  stage: lint_test
  image: node:20-alpine
  script:
    - npm run lint
    - npm test

build_image:
  stage: build
  image: docker:24
  services:
    - name: docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  script:
    - docker build -t "$IMAGE_TAG" -t "$IMAGE_LATEST" .
    - docker save "$IMAGE_TAG" "$IMAGE_LATEST" -o image.tar
  artifacts:
    paths:
      - image.tar
    expire_in: 1 hour

scan_image:
  stage: scan
  image: aquasec/trivy:0.49.1
  script:
    - trivy image --input image.tar --severity CRITICAL,HIGH --ignore-unfixed --exit-code 1 --format table | tee trivy-report.txt
  artifacts:
    when: always
    paths:
      - trivy-report.txt
  dependencies:
    - build_image

push_image:
  stage: push
  image: docker:24
  services:
    - name: docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
    - docker load -i image.tar
    - docker push "$IMAGE_TAG"
    - docker push "$IMAGE_LATEST"
  dependencies:
    - build_image

deploy_staging:
  stage: deploy
  image: alpine:3.19
  before_script:
    - apk add --no-cache openssh-client rsync
    - eval "$(ssh-agent -s)"
    - echo "$STAGING_SSH_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H "$STAGING_HOST" >> ~/.ssh/known_hosts
  script:
    - ssh "$STAGING_USER@$STAGING_HOST" "mkdir -p $STAGING_PATH"
    - |
      ssh "$STAGING_USER@$STAGING_HOST" "cat > $STAGING_PATH/.env << 'EOF'
      $STAGING_ENV_FILE
      EOF"
    - rsync -avz deploy/compose/ "$STAGING_USER@$STAGING_HOST:$STAGING_PATH/"
    - ssh "$STAGING_USER@$STAGING_HOST" "cd $STAGING_PATH && docker compose pull && docker compose up -d"
  only:
    - main
